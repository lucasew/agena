name: Build, Test and Auto-Release

on:
  push:
    branches: [ main, master ]
    tags:
      - '*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      new_version:
        description: 'Version bump type'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
  schedule:
    # Run every Saturday at 2 AM UTC (for automated dependency updates)
    - cron: '0 2 * * 6'

jobs:
  build-test-release:
    name: Build, Test and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      attestations: write
      id-token: write
      pull-requests: write
      checks: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Setup git config
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Setup mise
      uses: jdx/mise-action@v3

    - name: Grant execute permissions
      run: chmod +x gradlew make_release

    # Run unit tests
    - name: Run unit tests
      run: ./gradlew test --stacktrace

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          app/build/reports/tests/
          app/build/test-results/

    - name: Test Report
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: JUnit Test Results
        path: app/build/test-results/test*/**/*.xml
        reporter: java-junit
        fail-on-error: true

    # Build debug APK (for non-release builds)
    - name: Build debug APK
      if: github.event_name == 'pull_request' || (github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/'))
      run: ./gradlew assembleDebug --stacktrace

    - name: Upload debug APK artifact
      if: github.event_name == 'pull_request' || (github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/'))
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: app/build/outputs/apk/debug/*.apk

    # Make release if workflow_dispatch or schedule
    - name: Make release
      if: github.event_name != 'pull_request'
      env:
        NEW_VERSION: ${{ github.event.inputs.new_version }}
      run: |
        if [[ ! -z "$NEW_VERSION" ]]; then
          NO_TAG=1 ./make_release "$NEW_VERSION"
          echo "New version: $(cat version.txt)" >> $GITHUB_STEP_SUMMARY
          echo "RELEASE_VERSION=$(cat version.txt)" >> $GITHUB_ENV
        fi

    # Build release APK
    - name: Build release APK
      if: env.RELEASE_VERSION != '' && github.event_name != 'pull_request'
      run: ./gradlew assembleRelease --stacktrace

    # Create GitHub release
    - name: Create release
      if: env.RELEASE_VERSION != '' && github.event_name != 'pull_request'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG: v${{ env.RELEASE_VERSION }}
        TITLE: Release v${{ env.RELEASE_VERSION }}
      run: |
        gh release create "$TAG" \
          --title "$TITLE" \
          --generate-notes

    # Upload release APK
    - name: Upload release artifacts
      if: env.RELEASE_VERSION != '' && github.event_name != 'pull_request'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG: v${{ env.RELEASE_VERSION }}
      run: |
        gh release upload "$TAG" app/build/outputs/apk/release/*.apk --clobber
