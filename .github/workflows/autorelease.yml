name: Build, Test and Auto-Release

on:
  push:
    branches: [ main, master ]
    tags:
      - '*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      new_version:
        description: 'Version bump type'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
  schedule:
    # Run every Saturday at 2 AM UTC (for automated dependency updates)
    - cron: '0 2 * * 6'

jobs:
  build-test-release:
    name: Build, Test and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      attestations: write
      id-token: write
      pull-requests: write
      checks: write

    steps:
    - name: Checkout code
      uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      with:
        fetch-depth: 0

    - name: Setup git config
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Setup mise
      uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3

    - name: Grant execute permissions
      run: chmod +x gradlew make_release

    - name: Run codegen
      run: mise run codegen

    - name: Create Pull Request if there is new stuff from updaters
      if: github.event_name != 'pull_request'
      uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c # v6
      id: pr_create
      with:
        commit-message: "chore: update codegen"
        title: "chore: update codegen"
        body: "This PR updates the generated code."
        branch: "codegen-update"
        delete-branch: true

    - name: Stop if a pull request was created
      if: github.event_name != 'pull_request'
      env:
        PR_NUMBER: ${{ steps.pr_create.outputs.pull-request-number }}
      run: |
        if [[ ! -z "$PR_NUMBER" ]]; then
          echo "The update scripts changed something and a PR was created. Giving up deploy." >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

    # Run unit tests using mise
    - name: Run unit tests
      run: mise run test -- --stacktrace

    - name: Upload test results
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
      if: always()
      with:
        name: test-results
        path: |
          app/build/reports/tests/
          app/build/test-results/

    - name: Test Report
      uses: dorny/test-reporter@7b7927aa7da8b82e81e755810cb51f39941a2cc7 # v2
      if: always()
      with:
        name: JUnit Test Results
        path: app/build/test-results/test*/**/*.xml
        reporter: java-junit
        fail-on-error: true

    # Build debug APK
    - name: Build debug APK
      run: ./gradlew assembleDebug --stacktrace

    - name: Upload debug APK artifact
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
      with:
        name: debug-apk
        path: app/build/outputs/apk/debug/*.apk

    # Make release if workflow_dispatch or schedule
    - name: Make release
      if: github.event_name != 'pull_request'
      env:
        NEW_VERSION: ${{ github.event.inputs.new_version }}
      run: |
        if [[ ! -z "$NEW_VERSION" ]]; then
          NO_TAG=1 ./make_release "$NEW_VERSION"
          echo "New version: $(cat version.txt)" >> $GITHUB_STEP_SUMMARY
          echo "RELEASE_VERSION=$(cat version.txt)" >> $GITHUB_ENV
        fi

    # Build release APK (always, after potential version bump)
    - name: Build release APK
      run: ./gradlew assembleRelease --stacktrace

    - name: Upload release APK artifact
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
      with:
        name: release-apk
        path: app/build/outputs/apk/release/*.apk

    # Create GitHub release
    - name: Create release
      if: env.RELEASE_VERSION != '' && github.event_name != 'pull_request'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG: v${{ env.RELEASE_VERSION }}
        TITLE: Release v${{ env.RELEASE_VERSION }}
      run: |
        gh release create "$TAG" \
          --title "$TITLE" \
          --generate-notes

    # Rebuild both APKs after creating release (ensures correct version in both)
    - name: Rebuild debug APK for release
      if: env.RELEASE_VERSION != '' && github.event_name != 'pull_request'
      run: ./gradlew assembleDebug --stacktrace

    - name: Rebuild release APK for release
      if: env.RELEASE_VERSION != '' && github.event_name != 'pull_request'
      run: ./gradlew assembleRelease --stacktrace

    # Upload both APKs to GitHub release
    - name: Upload release artifacts
      if: env.RELEASE_VERSION != '' && github.event_name != 'pull_request'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG: v${{ env.RELEASE_VERSION }}
      run: |
        gh release upload "$TAG" app/build/outputs/apk/debug/*.apk --clobber
        gh release upload "$TAG" app/build/outputs/apk/release/*.apk --clobber
