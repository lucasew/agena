name: Build, Test and Auto-Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      new_version:
        description: 'Version bump type'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
  schedule:
    # Run every Saturday at 2 AM UTC (for automated dependency updates)
    - cron: '0 2 * * 6'

jobs:
  build-test-release:
    name: Build, Test and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      attestations: write
      id-token: write
      pull-requests: write
      checks: write

    steps:
    # Setup steps (always run)
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Setup mise
      uses: jdx/mise-action@v3

    - name: Grant execute permissions
      run: |
        chmod +x gradlew
        chmod +x make_release

    # Version bump and release (only on workflow_dispatch or schedule)
    - name: Bump version (DRY_RUN)
      if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
      env:
        DRY_RUN: "1"
        NEW_VERSION: ${{ github.event.inputs.new_version || 'patch' }}
      run: ./make_release $NEW_VERSION

    # Read version for later use
    - name: Read version
      id: version
      run: |
        VERSION=$(cat version.txt)
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $VERSION"

    # Commit, tag and push version bump
    - name: Commit and tag version
      if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add version.txt app/build.gradle
        git commit -m "bump to ${{ steps.version.outputs.VERSION }}"
        git tag "v${{ steps.version.outputs.VERSION }}"
        git push
        git push --tags

    # CI steps (test + build)
    - name: Run CI (test + build)
      run: mise ci

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          app/build/reports/tests/
          app/build/test-results/

    - name: Test Report
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: JUnit Test Results
        path: app/build/test-results/test*/**/*.xml
        reporter: java-junit
        fail-on-error: true

    # Build release APK for releases (workflow_dispatch/schedule or tags)
    - name: Build release APK
      if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || startsWith(github.ref, 'refs/tags/v')
      run: mise run build:release

    # Upload APK as artifact
    - name: Upload release APK artifact
      if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || startsWith(github.ref, 'refs/tags/v')
      uses: actions/upload-artifact@v4
      with:
        name: release-apk-${{ steps.version.outputs.VERSION }}
        path: app/build/outputs/apk/release/*.apk

    - name: Upload debug APK artifact
      if: ${{ !(github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || startsWith(github.ref, 'refs/tags/v')) }}
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk-${{ steps.version.outputs.VERSION }}
        path: app/build/outputs/apk/debug/*.apk

    # GitHub Release (workflow_dispatch/schedule or tags)
    - name: Create GitHub Release
      if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: Release v${{ steps.version.outputs.VERSION }}
        body: |
          ## AGENA - Gemini Browser for Android v${{ steps.version.outputs.VERSION }}

          ### What's New
          See commits since last release for details.

          ### Downloads
          - **agena-release.apk** - Release build (recommended)

          ### Requirements
          - Android 4.1 (API 16) or higher

          ### Features
          - Full Gemini protocol specification compliance
          - All status codes (10-69) supported
          - Input prompts with dialog support
          - TLS 1.2+ with SNI
          - Comprehensive error handling

          ### Installation
          1. Download the APK
          2. Enable "Install from unknown sources" in Android settings
          3. Install the APK
          4. Enjoy browsing Gemini!
        files: app/build/outputs/apk/release/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
