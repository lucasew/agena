name: Build, Test and Auto-Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      new_version:
        description: 'Version bump type'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
  schedule:
    # Run every Saturday at 2 AM UTC (for automated dependency updates)
    - cron: '0 2 * * 6'

jobs:
  build-test-release:
    name: Build, Test and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      attestations: write
      id-token: write
      pull-requests: write
      checks: write

    steps:
    # Setup steps (always run)
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permissions
      run: |
        chmod +x gradlew
        chmod +x make_release

    # Version bump (only on workflow_dispatch or schedule)
    - name: Bump version
      if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
      env:
        NEW_VERSION: ${{ github.event.inputs.new_version || 'patch' }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        ./make_release $NEW_VERSION

    # Read version for later use
    - name: Read version
      id: version
      run: |
        VERSION=$(cat version.txt)
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $VERSION"

    # Test steps (always run)
    - name: Run unit tests
      run: ./gradlew test --stacktrace

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          app/build/reports/tests/
          app/build/test-results/

    - name: Test Report
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: JUnit Test Results
        path: app/build/test-results/test*/**/*.xml
        reporter: java-junit
        fail-on-error: true

    # Build steps (always run)
    - name: Build release APK
      if: startsWith(github.ref, 'refs/tags/v')
      run: ./gradlew assembleRelease --stacktrace

    - name: Build debug APK
      if: ${{ !startsWith(github.ref, 'refs/tags/v') }}
      run: ./gradlew assembleDebug --stacktrace

    # Upload APK as artifact (always run)
    - name: Upload release APK artifact
      if: startsWith(github.ref, 'refs/tags/v')
      uses: actions/upload-artifact@v4
      with:
        name: release-apk-${{ steps.version.outputs.VERSION }}
        path: app/build/outputs/apk/release/*.apk

    - name: Upload debug APK artifact
      if: ${{ !startsWith(github.ref, 'refs/tags/v') }}
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk-${{ steps.version.outputs.VERSION }}
        path: app/build/outputs/apk/debug/*.apk

    # GitHub Release (only on version tags)
    - name: Get tag name
      if: startsWith(github.ref, 'refs/tags/v')
      id: tag_name
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        name: Release ${{ steps.tag_name.outputs.TAG_NAME }}
        body: |
          ## AGENA - Gemini Browser for Android v${{ steps.version.outputs.VERSION }}

          ### What's New
          See commits since last release for details.

          ### Downloads
          - **agena-release.apk** - Release build (recommended)

          ### Requirements
          - Android 4.1 (API 16) or higher

          ### Features
          - Full Gemini protocol specification compliance
          - All status codes (10-69) supported
          - Input prompts with dialog support
          - TLS 1.2+ with SNI
          - Comprehensive error handling

          ### Installation
          1. Download the APK
          2. Enable "Install from unknown sources" in Android settings
          3. Install the APK
          4. Enjoy browsing Gemini!
        files: app/build/outputs/apk/release/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
