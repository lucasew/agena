name: CI

on:
  push:
    branches:
      - '**'
  pull_request:
  workflow_call:
    outputs:
      apk-path:
        description: "Path to the built APK"
        value: ${{ jobs.build.outputs.apk-path }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      apk-path: ${{ steps.find-apk.outputs.apk-path }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup mise
        uses: jdx/mise-action@v2
        with:
          install: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run CI tasks via mise
        run: mise run ci

      - name: Find built APK
        id: find-apk
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" -type f | head -n 1)
          echo "apk-path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "Found APK at: $APK_PATH"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30
